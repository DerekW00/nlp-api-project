Final code cleanup and optimizations
